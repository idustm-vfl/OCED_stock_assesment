# Copilot Instructions for OCED Stock Assessment

- Goal: track covered-call positions and option signals using Massive data; core flow is ingest ➜ monitor/picker/oced ➜ logs/reports/DB.
- CLI entrypoints (python -m massive_tracker.cli): init; wizard; run (calls run_once); ingest YYYY-MM-DD; rollup; picker; oced; stream. Run reads data/config/run_profile.json to auto-toggle ingest/monitor/picker/rollup/oced.
- Data/DB layout: SQLite at data/sqlite/tracker.db; JSONL logs in data/logs/ (weekly_picks.jsonl, option_features.jsonl, monitor_events.jsonl, outcomes.jsonl); reports in data/reports/ (summary.md, CSV rollups); raw downloads in data/raw/.
- Env config: S3 flatfile download needs MASSIVE_S3_ENDPOINT, MASSIVE_S3_BUCKET, MASSIVE_STOCKS_PREFIX, MASSIVE_OPTIONS_PREFIX plus access/secret keys (accepts AWS_ACCESS_KEY_ID / MASSIVE_ACCESS_KEY / M_S3_ACCESS_KEY_ID and MASSIVE_SECRET_KEY / AWS_SECRET_ACCESS_KEY / M_S3_SECRET_ACCESS_KEY). REST calls need MASSIVE_REST_BASE + MASSIVE_API_KEY (or MASSIVE_ACCESS_KEY). Websocket/stream uses MASSIVE_API_KEY/MASSIVE_WS_API_KEY/MASSIVE_KEY. Missing keys raise at load_config or ws_client/oced ingest.
- Ingestion ([massive_tracker/ingest.py]): downloads Massive flatfiles for a date with backshift up to 30 days; options/stocks independently toggled; logs ingest_state via DB.log_event and prints backshift notice.
- Storage ([massive_tracker/store.py]): connect() enforces WAL + schema/migrations; tables: tickers, option_positions (shares/stock_basis/premium_open defaulted), market_last, options_last cache, ingest_state, oced_scores; use option_key(ticker|expiry|right|strike) for cache keys. Always go through DB.connect() when writing SQL.
- Watchlists ([massive_tracker/watchlist.py]): uppercase tickers; add/disable/remove tickers; add_contract validates right in {C,P}, default shares=100; list_open_contracts returns OPEN positions only; get_position_details used by monitor fallbacks.
- Monitoring ([massive_tracker/monitor.py]): for every OPEN contract, fetch snapshot via Massive REST (if configured) with DB cache fallbacks; computes scenarios via options_features.compute_cc_scenarios and signals.compute_signal_features; writes option_features.jsonl/monitor_events.jsonl. Handles missing schema defensively; avoid breaking changes to snapshot fields.
- Picker ([massive_tracker/picker.py]): ranks enabled tickers using inverse price from DB.market_last; computes basic fft/fractal signals; appends weekly_picks.jsonl; top_n default 5.
- OCED scan ([massive_tracker/oced.py]): builds close/return features (fft entropy, fractal roughness, entropy-based scores, premium heuristics), supports Massive REST or yfinance OHLCV fetch, stores per-ticker results in oced_scores; ticker universe + lane/category mappings defined in this file.
- Weekly rollup ([massive_tracker/weekly_rollup.py]): flattens weekly_picks.jsonl (signal/decision) to CSV and joins positions.jsonl↔outcomes.jsonl when present; outputs to data/reports/.
- Summary ([massive_tracker/summary.py]): regenerates data/reports/summary.md from latest logs (recent picks, option health, outcomes); run_once prints location after run.
- Real-time/streaming ([massive_tracker/ws_client.py]): MassiveWSClient writes all events to data/logs/ws_events.jsonl and caches last prices in DB.market_last; make_monitor_bar_handler triggers run_monitor on near-strike/rapid-up with cooldown. ws_ingest.py is legacy Massive SDK consumer that updates caches for AM bars and options using OCC symbol parsing.
- Signals/math helpers: [massive_tracker/signals.py] provides fft/fractal feature computation with optional numpy; [massive_tracker/options_features.py] houses covered-call scenario math, anomaly detection, and recommendation logic (MANUAL_CLOSE_OK/HOLD variants) driven by spreads and delta_gain thresholds.
- Wizard/profile: run_profile.py loads/saves run defaults under data/config/run_profile.json; wizard in cli.py surfaces add/remove/close actions (interactive) and saves defaults.
- Dependencies: requirements.txt includes pandas, numpy, requests, websocket-client, yfinance, scikit-learn; some are optional but functions degrade gracefully when missing (signals returns status, oced falls back to yfinance).
- Conventions: tickers uppercase; right is C/P; expiry YYYY-MM-DD; JSONL writers append only; prefer pandas/json_normalize for flattening; avoid deleting existing logs/DB tables.
- Testing/dev tips: run cli init then wizard to seed watchlist; use run to exercise full pipeline with default date=prior day; stream with --monitor-triggers to auto-run monitor; rollup regenerates CSVs after logging. Ensure data/raw/ and data/logs/ exist (code will mkdir).
- When adding features, keep compatibility with DB schema and JSONL payload keys consumed by summary/rollup; extend ingest/monitor without breaking optional Massive/yfinance/requests paths.
